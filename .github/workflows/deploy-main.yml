name: Deploy Main Branch to Codespace

on:
  push:
    branches:
      - main   

jobs:
  deploy-to-codespace:

    runs-on: self-hosted 

    steps:
      - name: Clean and Checkout Latest Code
        run: |
          echo "üßπ Cleaning working directory..."
          cd /workspaces/Context-IQ/actions-runner/_work/Context-IQ/Context-IQ
          
          git fetch origin main
          git reset --hard origin/main
          git clean -fdx
          
          echo "‚úÖ Repository synced with remote main branch"

      - name: Verify Current Branch and Commit
        run: |
          echo "üìç Current Branch: $(git branch --show-current)"
          echo "üìù Latest Commit: $(git log -1 --oneline)"

      - name: Stop Existing Containers
        run: |
          echo "üõë Stopping existing containers..."
          docker compose -f ./docker/docker-compose.yml down || true

      - name: Rebuild and Start Containers
        run: |
          echo "üê≥ Building and starting containers..."
          docker compose -f ./docker/docker-compose.yml up -d --build --force-recreate

      - name: Wait for Services
        run: |
          echo "‚è≥ Waiting for services to initialize..."
          sleep 15

      - name: Health Check
        run: |
          echo "üîç Checking FastAPI health..."
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl --silent --fail http://localhost:8000/docs > /dev/null; then
              echo "‚úÖ Deployment Successful! FastAPI is running."
              echo "üåê Access at: http://localhost:8000/docs"
              exit 0
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚ö†Ô∏è  Attempt $RETRY_COUNT/$MAX_RETRIES failed. Retrying in 5 seconds..."
              sleep 5
            fi
          done
          
          echo "‚ùå Deployment Failed! FastAPI did not respond after $MAX_RETRIES attempts."
          echo "üìã Checking container logs..."
          docker compose -f ./docker/docker-compose.yml logs --tail=50
          exit 1

      - name: Show Running Containers
        if: success()
        run: |
          echo "üì¶ Running containers:"
          docker compose -f ./docker/docker-compose.yml ps